<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Messages & Chat</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link rel="stylesheet" href="./messagepageforuser.css" />
    <link rel="stylesheet" href="../../assets/styles/animation.css" />
    <link rel="stylesheet" href="../../assets/styles/usersidebar.css" />
  </head>
  <body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
      <div class="logo">
        <span>Dashboard</span>
      </div>
      <div class="navigation">
        <a href="../../../index.html" class="nav-link">
          <i class="fas fa-home"></i> <span>Home</span>
        </a>
        <a href="../account/account.html" class="nav-link">
          <i class="fas fa-user"></i> <span>Profile</span>
        </a>
        <a href="../wishlist/wishlist.html" class="nav-link">
          <i class="fas fa-heart"></i> <span>Wishlist</span>
        </a>
        <a href="../mycart/mycart.html" class="nav-link">
          <i class="fas fa-shopping-cart"></i> <span>Cart</span>
        </a>
        <a href="../OrderHistory/Orderhistory.html" class="nav-link">
          <i class="fas fa-history"></i> <span>Orders</span>
        </a>
        <a href="../securitysettings/securitysettings.html" class="nav-link">
          <i class="fas fa-shield-alt"></i> <span>Security</span>
        </a>
        <a href="../support/support.html" class="nav-link">
          <i class="fas fa-question-circle"></i> <span>Support</span>
        </a>
        <a href="../messagepageforuser/messagepageforuser.html" class="nav-link active">
          <i class="fas fa-envelope"></i> <span>Messages</span>
        </a>
        <a href="../../sellerpages/bussinessprofile/bussinessprofile.html" class="nav-link">
          <i class="fas fa-store"></i> <span>Seller Portal</span>
        </a>
      </div>
      <div class="sidebar-footer">
        <a href="#" id="logout-btn" class="nav-link">
          <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
        </a>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
      <div class="top-bar">
        <div class="hamburger-menu">
          <i class="fas fa-bars"></i>
        </div>
        <div class="user-welcome">
          <h2>Messages & Chat</h2>
        </div>
        <div class="user-actions">
          <a href="#" class="notification">
            <i class="fas fa-bell"></i><span class="badge">3</span>
          </a>
          <div class="user-avatar">
            <img src="../../assets/images/new/defaultpfp.png" alt="User Avatar" />
          </div>
        </div>
      </div>

      <!-- Chat Container -->
      <div class="chat-container" id="chatContainer">
        <!-- Chat List Panel -->
        <div class="chat-list" id="chatList">
          <!-- Chat list items will be rendered here -->
        </div>

        <!-- Chat Conversation Panel -->
        <div class="chat-conversation" id="chatConversation">
          <div class="chat-header" id="chatHeader">
            <span class="back-btn" id="backBtn" style="display: none">
              <i class="fas fa-arrow-left"></i> Back
            </span>
            <!-- Chat avatar will be updated with seller's photo -->
            <img src="../../assets/images/new/defaultpfp.png" alt="Seller Avatar" class="chat-avatar" />
            <span class="chat-seller-name" id="chatSellerName">Select a chat</span>
            <span class="close-chat" id="closeChat"><i class="fas fa-times"></i></span>
          </div>
          <div class="chat-messages" id="chatMessages">
            <p class="no-chat">No conversation selected.</p>
          </div>
          <div class="chat-input" id="chatInputArea">
            <!-- Replying context (hidden by default) -->
            <div class="replying-context" id="replyContext" style="display: none">
              <span id="replyText"></span>
              <button id="cancelReply">&times;</button>
            </div>
            <div class="chat-input-row">
              <input type="text" id="messageInput" placeholder="Type a message..." />
              <button class="img-btn" id="uploadImgBtn">
                <i class="fas fa-image"></i>
              </button>
              <button id="sendMessage">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
            <!-- Hidden file input for images -->
            <input type="file" id="imgUpload" accept="image/*" />
          </div>
        </div>
      </div>
    </div>

    <!-- Seller Details Modal (slides in from right) -->
    <div class="modal-overlay" id="sellerModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Seller Details</h3>
          <span class="modal-close" id="closeSellerModal"><i class="fas fa-times"></i></span>
        </div>
        <div class="seller-details" id="sellerDetails">
          <img src="" alt="Seller Profile" id="sellerModalPfp" />
          <p><strong>Name:</strong> <span id="sellerModalName"></span></p>
          <p><strong>Email:</strong> <span id="sellerModalEmail"></span></p>
          <p><strong>Contact:</strong> <span id="sellerModalContact"></span></p>
          <p>
            <strong>Social:</strong>
            <a href="#" target="_blank" id="sellerModalSocial">Visit Profile</a>
          </p>
          <p><strong>Rating:</strong> <span id="sellerModalRating"></span>/5</p>
        </div>
      </div>
    </div>

    <!-- Inline Module Script for Chat Functionality with Debug Logging -->
    <script type="module">
      import { auth, db } from '../../database/config.js';
      import {
        collection,
        query,
        orderBy,
        addDoc,
        serverTimestamp,
        onSnapshot,
        doc,
        getDoc,
        updateDoc,
        getDocs,
      } from 'https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js';
      import {
        onAuthStateChanged,
        signOut,
      } from 'https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js';

      // --- URL Parameter Processing ---
      const urlParams = new URLSearchParams(window.location.search);
      const sellerIdParam = urlParams.get('sellerId'); // Passed from redirect link
      const listingIdParam = urlParams.get('listingId'); // Listing/product ID if provided
      console.log('URL parameters:', { sellerIdParam, listingIdParam });

      // --- DOM Elements ---
      const chatListEl = document.getElementById('chatList');
      const chatHeader = document.getElementById('chatHeader');
      const chatMessagesEl = document.getElementById('chatMessages');
      const messageInputEl = document.getElementById('messageInput');
      const sendButtonEl = document.getElementById('sendMessage');
      const uploadImgBtn = document.getElementById('uploadImgBtn');
      const imgUploadEl = document.getElementById('imgUpload');
      const replyContext = document.getElementById('replyContext');
      const replyText = document.getElementById('replyText');
      const cancelReplyBtn = document.getElementById('cancelReply');
      const backBtn = document.getElementById('backBtn');
      const closeChatBtn = document.getElementById('closeChat');
      const chatInputArea = document.getElementById('chatInputArea');

      // Seller modal elements
      const sellerModal = document.getElementById('sellerModal');
      const closeSellerModal = document.getElementById('closeSellerModal');

      // --- Global Chat State & Product Reference ---
      let currentChatId = null;
      let replyingTo = null;
      let lastMessageDate = null;
      let currentChatUnsubscribe = null; // For Firestore onSnapshot listener

      // For product reference details (if arriving via listing)
      let productReferenceData = null;
      let localProductReferenceSent = false;

      // --- Utility Functions ---
      function appendDateDivider(date) {
        const divider = document.createElement('div');
        divider.className = 'date-divider';
        divider.textContent = date;
        chatMessagesEl.appendChild(divider);
      }

      function appendMessage(sender, text, replyRef, time, date, scroll = true) {
        console.log('Appending message:', { sender, text, time, date });
        if (lastMessageDate !== date) {
          appendDateDivider(date);
          lastMessageDate = date;
        }
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message', sender === 'You' ? 'you' : 'seller');

        // Message header with sender and time
        const headerDiv = document.createElement('div');
        headerDiv.className = 'message-header';
        headerDiv.innerHTML = `<span class="sender-label">${sender}:</span>
                               <span class="message-time">${time}</span>`;
        msgDiv.appendChild(headerDiv);

        // Message body
        const bodyDiv = document.createElement('div');
        bodyDiv.className = 'message-body';
        bodyDiv.textContent = text;
        msgDiv.appendChild(bodyDiv);

        // Reply button (appears on hover)
        const replyBtn = document.createElement('span');
        replyBtn.classList.add('reply-btn');
        replyBtn.innerHTML = '<i class="fas fa-reply"></i>';
        replyBtn.title = 'Reply';
        replyBtn.addEventListener('click', () => {
          replyingTo = text;
          replyContext.style.display = 'flex';
          replyText.textContent = text;
          console.log('Replying to message:', text);
        });
        msgDiv.appendChild(replyBtn);

        chatMessagesEl.appendChild(msgDiv);
        if (scroll) chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
      }

      function clearMessages() {
        console.log('Clearing messages');
        chatMessagesEl.innerHTML = '';
        lastMessageDate = null;
      }

      // --- Chat Conversation Functions ---
      // Loads (or creates) a conversation between the current user and the seller.
      async function loadConversation(sellerId) {
        const currentUserUid = auth.currentUser.uid;
        // Create a unique chat ID based on both IDs.
        const chatId = `${currentUserUid}_${sellerId}`;
        currentChatId = chatId;
        console.log('Loading conversation for seller:', sellerId, 'Chat ID:', chatId);
        chatInputArea.style.display = 'block';

        // Fetch seller info from global sellers collection.
        const sellerDoc = await getDoc(doc(db, 'sellers', sellerId));
        if (!sellerDoc.exists()) {
          console.log('Seller not found for sellerId:', sellerId);
        }
        const sellerData = sellerDoc.exists() ? sellerDoc.data() : {};
        console.log('Seller data:', sellerData);
        // Update the chat header with the seller's profile.
        chatHeader.querySelector('.chat-avatar').src =
          sellerData.profilePicUrl || '../../assets/images/new/defaultpfp.png';
        document.getElementById('chatSellerName').textContent =
          sellerData.businessName || 'Seller';

        // Set up a real-time listener for messages.
        const messagesRef = collection(db, 'chats', chatId, 'messages');
        if (currentChatUnsubscribe) {
          console.log('Unsubscribing from previous listener');
          currentChatUnsubscribe();
        }
        currentChatUnsubscribe = onSnapshot(
          query(messagesRef, orderBy('timestamp', 'asc')),
          (snapshot) => {
            console.log('onSnapshot - messages updated, count:', snapshot.size);
            clearMessages();
            snapshot.forEach((docSnap) => {
              const msg = docSnap.data();
              const time = msg.timestamp
                ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString()
                : 'Now';
              const date = msg.timestamp
                ? new Date(msg.timestamp.seconds * 1000).toLocaleDateString()
                : 'Today';
              appendMessage(
                msg.senderId === currentUserUid ? 'You' : 'Seller',
                msg.text,
                msg.reply || null,
                time,
                date,
                false
              );
            });
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
          }
        );
      }

      // Renders the chat list. If a sellerId is provided via URL, load that conversation.
      // Otherwise, query all chats that the current user is a part of.
      async function renderChatList() {
        const currentUserUid = auth.currentUser.uid;
        if (sellerIdParam) {
          console.log('renderChatList: sellerIdParam exists', sellerIdParam);
          // Fetch seller info from global sellers collection.
          const sellerDoc = await getDoc(doc(db, 'sellers', sellerIdParam));
          console.log('Fetched sellerDoc:', sellerDoc.exists() ? sellerDoc.data() : "no seller data");
          const sellerData = sellerDoc.exists() ? sellerDoc.data() : {};
          const chatItem = document.createElement('div');
          chatItem.className = 'chat-item active';
          chatItem.setAttribute('data-id', sellerIdParam);
          chatItem.innerHTML = `
            <img src="${
              sellerData.profilePicUrl || '../../assets/images/new/defaultpfp.png'
            }" alt="${sellerData.businessName || 'Seller'}" class="chat-avatar" />
            <div class="chat-info">
              <span class="chat-name">${sellerData.businessName || 'Seller'}</span>
            </div>
            <div class="chat-time">Now</div>
          `;
          chatItem.addEventListener('click', () => {
            console.log('Chat item clicked for seller', sellerIdParam);
            loadConversation(sellerIdParam);
          });
          chatListEl.innerHTML = '';
          chatListEl.appendChild(chatItem);
        } else {
          console.log('renderChatList: No sellerIdParam, querying all chats for current user');
          const chatsRef = collection(db, 'chats');
          const querySnapshot = await getDocs(chatsRef);
          let userChats = [];
          querySnapshot.forEach((docSnap) => {
            if (docSnap.id.startsWith(currentUserUid + '_')) {
              userChats.push({ chatId: docSnap.id, ...docSnap.data() });
            }
          });
          console.log('User chats found:', userChats);
          if (userChats.length === 0) {
            chatListEl.innerHTML = "<p class='no-chat'>You have no chats.</p>";
            chatMessagesEl.innerHTML = "<p class='no-chat'>You have no chats.</p>";
            chatInputArea.style.display = 'none';
          } else {
            chatListEl.innerHTML = '';
            for (const chat of userChats) {
              const parts = chat.chatId.split('_');
              const sellerId = parts[1]; // Chat id format: currentUserUid_sellerId
              console.log('Rendering chat for sellerId:', sellerId);
              const sellerDoc = await getDoc(doc(db, 'sellers', sellerId));
              const sellerData = sellerDoc.exists() ? sellerDoc.data() : {};
              const chatItem = document.createElement('div');
              chatItem.className = 'chat-item';
              chatItem.setAttribute('data-id', sellerId);
              chatItem.innerHTML = `
                <img src="${
                  sellerData.profilePicUrl || '../../assets/images/new/defaultpfp.png'
                }" alt="${sellerData.businessName || 'Seller'}" class="chat-avatar" />
                <div class="chat-info">
                  <span class="chat-name">${sellerData.businessName || 'Seller'}</span>
                  <span class="chat-preview">Tap to view conversation</span>
                </div>
                <div class="chat-time">Now</div>
              `;
              chatItem.addEventListener('click', () => {
                console.log('Chat item clicked for seller', sellerId);
                loadConversation(sellerId);
              });
              chatListEl.appendChild(chatItem);
            }
          }
        }
      }

      // --- Navigation & Event Listeners ---
      backBtn.addEventListener('click', () => {
        console.log('Back button clicked');
        document.getElementById('chatContainer').classList.remove('mobile-active');
      });

      closeChatBtn.addEventListener('click', () => {
        console.log('Close chat clicked');
        currentChatId = null;
        clearMessages();
        document.getElementById('chatSellerName').textContent = 'Select a chat';
        chatMessagesEl.innerHTML = "<p class='no-chat'>Select a chat</p>";
        chatInputArea.style.display = 'none';
        document.querySelectorAll('.chat-item').forEach((item) => item.classList.remove('active'));
      });

      // Send text message – if a listing id is provided and this is the first message in this instance,
      // attach the product reference details.
      sendButtonEl.addEventListener('click', async () => {
        const text = messageInputEl.value.trim();
        if (!text || !currentChatId) {
          console.log('Send aborted: missing text or currentChatId');
          return;
        }
        const currentUserUid = auth.currentUser.uid;
        const messagesRef = collection(db, 'chats', currentChatId, 'messages');

        // Build the basic message payload.
        const messageData = {
          text,
          senderId: currentUserUid,
          timestamp: serverTimestamp(),
          read: false,
          reply: replyingTo || null,
        };

        if (listingIdParam && productReferenceData && !localProductReferenceSent) {
          console.log('Attaching product reference to first message:', productReferenceData);
          messageData.productReference = productReferenceData;
          localProductReferenceSent = true;
        } else {
          console.log('Sending normal message:', messageData);
        }

        try {
          await addDoc(messagesRef, messageData);
          console.log('Message sent successfully');
        } catch (error) {
          console.error('Error sending message:', error);
        }
        messageInputEl.value = '';
        replyingTo = null;
        replyContext.style.display = 'none';
      });

      // Send on Enter key press.
      messageInputEl.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          console.log('Enter key pressed in message input');
          sendButtonEl.click();
        }
      });

      // Image upload functionality.
      uploadImgBtn.addEventListener('click', () => {
        console.log('Upload image button clicked');
        imgUploadEl.click();
      });
      imgUploadEl.addEventListener('change', () => {
        const file = imgUploadEl.files[0];
        if (file && currentChatId) {
          console.log('Image file selected:', file);
          const reader = new FileReader();
          reader.onload = async function (ev) {
            const currentUserUid = auth.currentUser.uid;
            const messagesRef = collection(db, 'chats', currentChatId, 'messages');
            try {
              await addDoc(messagesRef, {
                text: '[Image]',
                senderId: currentUserUid,
                timestamp: serverTimestamp(),
                read: false,
                reply: replyingTo || null,
              });
              console.log('Image message sent successfully');
            } catch (error) {
              console.error('Error sending image message:', error);
            }
            messageInputEl.value = '';
            replyingTo = null;
            replyContext.style.display = 'none';
          };
          reader.readAsDataURL(file);
        }
        imgUploadEl.value = '';
      });

      // Cancel reply action.
      cancelReplyBtn.addEventListener('click', () => {
        console.log('Cancel reply clicked');
        replyingTo = null;
        replyContext.style.display = 'none';
      });

      // Seller details modal functionality.
      document.getElementById('chatSellerName').addEventListener('click', async () => {
        if (currentChatId) {
          console.log('Opening seller details modal for sellerId:', sellerIdParam);
          const sellerDoc = await getDoc(doc(db, 'sellers', sellerIdParam));
          const sellerData = sellerDoc.exists() ? sellerDoc.data() : {};
          document.getElementById('sellerModalPfp').src =
            sellerData.profilePicUrl || '../../assets/images/new/defaultpfp.png';
          document.getElementById('sellerModalName').textContent =
            sellerData.businessName || 'Seller';
          document.getElementById('sellerModalEmail').textContent =
            sellerData.email || 'No email provided';
          document.getElementById('sellerModalContact').textContent =
            sellerData.phone || 'No contact provided';
          document.getElementById('sellerModalSocial').href =
            sellerData.facebook || '#';
          document.getElementById('sellerModalRating').textContent =
            typeof sellerData.rating === 'number'
              ? sellerData.rating.toFixed(1)
              : 'N/A';
          sellerModal.style.display = 'flex';
        }
      });
      closeSellerModal.addEventListener('click', () => {
        console.log('Closing seller modal');
        sellerModal.style.display = 'none';
      });

      // --- Initialization ---
      onAuthStateChanged(auth, async (user) => {
        if (user && user.emailVerified) {
          console.log('User signed in:', user.uid);
          if (listingIdParam) {
            console.log('ListingId provided, fetching product details for listingId:', listingIdParam);
            const productDoc = await getDoc(doc(db, 'items', listingIdParam));
            if (productDoc.exists()) {
              const productData = productDoc.data();
              productReferenceData = {
                productName: productData.itemName || 'Product',
                productImage: productData.imageURL || '../../assets/images/new/defaultpfp.png',
              };
              console.log('Product reference data set:', productReferenceData);
            } else {
              console.log('No product found for listingId:', listingIdParam);
            }
          }
          // Render chat list (either for a specific seller or for all chats)
          await renderChatList();
          // If sellerId is provided in URL, automatically load that conversation.
          if (sellerIdParam) {
            console.log('Loading conversation for sellerId from URL:', sellerIdParam);
            loadConversation(sellerIdParam);
          }
        } else {
          console.log('User not signed in or email not verified.');
          window.location.href = '../../index.html';
        }
      });

      // Logout handler.
      document.getElementById('logout-btn').addEventListener('click', () => {
        signOut(auth)
          .then(() => {
            console.log('User signed out');
            window.location.href = '../../index.html';
          })
          .catch((error) => console.error('Error signing out:', error));
      });
    </script>
  </body>
</html>